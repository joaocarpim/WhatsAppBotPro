import sys
import time
import re
import os
import subprocess
from datetime import datetime
from PySide6.QtWidgets import (QApplication, QMainWindow, QWidget, QVBoxLayout,
                               QHBoxLayout, QLabel, QPushButton, QTextEdit, QFrame,
                               QMessageBox, QGraphicsDropShadowEffect)
from PySide6.QtCore import Qt, QThread, Signal, QTimer
from PySide6.QtGui import QFont, QColor
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.common.action_chains import ActionChains
from selenium.common.exceptions import TimeoutException, NoSuchElementException
from webdriver_manager.chrome import ChromeDriverManager


class WhatsAppBot:
    def __init__(self):
        self.driver = None
        self.base_dir = os.path.abspath(os.getcwd())
        self.session_dir = os.path.join(self.base_dir, "whatsapp_session")

    def limpar_sessao(self):
        """Remove sess√£o corrompida do WhatsApp"""
        try:
            import shutil
            if os.path.exists(self.session_dir):
                print("[INFO] Limpando sess√£o antiga...")
                shutil.rmtree(self.session_dir, ignore_errors=True)
                print("[INFO] Sess√£o limpa com sucesso")
                return True
        except Exception as e:
            print(f"[AVISO] Erro ao limpar sess√£o: {e}")
        return False

    def iniciar(self, headless=False):
        if not os.path.exists(self.session_dir):
            os.makedirs(self.session_dir)

        options = Options()
        if headless:
            options.add_argument("--headless=new")

        options.add_argument(f"--user-data-dir={self.session_dir}")
        options.add_argument("--no-sandbox")
        options.add_argument("--disable-dev-shm-usage")
        options.add_argument("--disable-gpu")
        options.add_argument("--disable-extensions")
        options.add_argument("--log-level=3")
        options.add_argument("--start-maximized")
        options.add_argument("--disable-blink-features=AutomationControlled")
        options.add_experimental_option(
            "excludeSwitches", ["enable-automation", "enable-logging"])
        options.add_experimental_option("useAutomationExtension", False)

        try:
            print("[SISTEMA] Inicializando Driver...")
            driver_path = ChromeDriverManager().install()

            service = Service(driver_path)
            if os.name == 'nt':
                service.creation_flags = subprocess.CREATE_NO_WINDOW

            self.driver = webdriver.Chrome(service=service, options=options)
            print("[SISTEMA] Acessando WhatsApp Web...")
            self.driver.get("https://web.whatsapp.com")
            return True

        except Exception as e:
            print(f"[ERRO CR√çTICO] Falha ao iniciar: {e}")
            return False

    def aguardar_login(self):
        """Verifica se logou procurando elementos chave"""
        print("[LOGIN] Aguardando autentica√ß√£o...")
        inicio = time.time()

        while (time.time() - inicio) < 120:
            try:
                if len(self.driver.find_elements(By.ID, "pane-side")) > 0:
                    return True
                if len(self.driver.find_elements(By.XPATH, "//header//img")) > 0:
                    return True
                if len(self.driver.find_elements(By.XPATH, '//div[@contenteditable="true"]')) > 0:
                    return True
                time.sleep(1)
            except:
                time.sleep(1)
        return False

    def formatar_numero(self, numero):
        numero = re.sub(r"\D", "", numero)
        if len(numero) < 10:
            return None, "N√∫mero muito curto"
        if len(numero) > 15:
            return None, "N√∫mero muito longo"
        if len(numero) in [10, 11]:
            numero = "55" + numero
        return numero, "OK"

    def enviar(self, numero, mensagem):
        try:
            print(f"\n[ENVIO] ========================================")
            print(f"[ENVIO] Iniciando envio para: {numero}")
            print(
                f"[ENVIO] Tem mensagem: {bool(mensagem and mensagem.strip())}")

            # 1. Valida e Navega
            print(f"[ENVIO] Formatando n√∫mero...")
            num_fmt, status = self.formatar_numero(numero)
            if not num_fmt:
                print(f"[ENVIO] ‚úó N√∫mero inv√°lido: {status}")
                return False, status

            print(f"[ENVIO] ‚úì N√∫mero formatado: {num_fmt}")

            url = f"https://web.whatsapp.com/send?phone={num_fmt}"
            print(f"[ENVIO] Navegando para: {url}")
            self.driver.get(url)
            print(f"[ENVIO] ‚úì Navega√ß√£o conclu√≠da")

            # 2. Aguarda Chat Carregar
            print(f"[ENVIO] Aguardando chat carregar (timeout: 30s)...")
            try:
                WebDriverWait(self.driver, 30).until(
                    EC.presence_of_element_located(
                        (By.XPATH, '//div[@contenteditable="true"][@data-tab="10"]'))
                )
                print(f"[ENVIO] ‚úì Chat carregado (caixa de texto encontrada)")
            except TimeoutException:
                print(f"[ENVIO] ‚úó Timeout ao carregar chat")

                invalid_indicators = self.driver.find_elements(By.XPATH,
                                                               '//div[contains(text(), "n√∫mero de telefone")]|//div[contains(text(), "phone number")]')

                if invalid_indicators:
                    print(f"[ENVIO] ‚úó N√∫mero n√£o est√° no WhatsApp")
                    return False, "N√∫mero inv√°lido/Sem Whats"

                print(f"[ENVIO] ‚úó Timeout gen√©rico (Internet/Whats lento)")
                return False, "Timeout (Internet/Whats lento)"

            print(f"[ENVIO] Aguardando 1.5s adicional...")
            time.sleep(1.5)

            # 3. ENVIA TEXTO
            if mensagem and mensagem.strip():
                print(f"[ENVIO] ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê")
                print(f"[ENVIO] MODO: TEXTO")
                print(f"[ENVIO] Tamanho: {len(mensagem)} caracteres")
                print(f"[ENVIO] Linhas: {len(mensagem.split('\\n'))}")

                box = self.driver.find_element(
                    By.XPATH, '//div[@contenteditable="true"][@data-tab="10"]')

                print(f"[ENVIO] ‚úì Caixa de texto encontrada")

                linhas = mensagem.split("\n")
                for i, linha in enumerate(linhas):
                    print(f"[ENVIO] Digitando linha {i+1}/{len(linhas)}...")
                    box.send_keys(linha)
                    if i < len(linhas) - 1:
                        ActionChains(self.driver).key_down(Keys.SHIFT).send_keys(
                            Keys.ENTER).key_up(Keys.SHIFT).perform()

                time.sleep(0.5)
                print(f"[ENVIO] Procurando bot√£o enviar...")

                try:
                    btn_enviar = WebDriverWait(self.driver, 5).until(
                        EC.element_to_be_clickable(
                            (By.XPATH, '//button[@aria-label="Enviar"]'))
                    )
                    btn_enviar.click()
                    print(f"[ENVIO] ‚úì Clicou no bot√£o enviar")
                except:
                    print(f"[ENVIO] Bot√£o n√£o encontrado, usando Enter...")
                    box.send_keys(Keys.ENTER)
                    print(f"[ENVIO] ‚úì Enter enviado")

                time.sleep(2)
                print(f"[ENVIO] ‚úì‚úì‚úì Texto enviado com sucesso!")
                return True, "‚úÖ Texto enviado"

            print(f"[ENVIO] ‚úì Envio conclu√≠do")
            return True, "‚úÖ Enviado com sucesso"

        except Exception as e:
            print(f"[ENVIO] ‚úó‚úó‚úó ERRO GERAL: {e}")
            import traceback
            traceback.print_exc()
            return False, f"‚ùå Erro: {str(e)}"

    def fechar(self):
        if self.driver:
            self.driver.quit()


class ConnectionThread(QThread):
    log_signal = Signal(str, str)
    status_signal = Signal(bool)

    def __init__(self, bot):
        super().__init__()
        self.bot = bot

    def run(self):
        self.log_signal.emit("‚ñ∏ INICIANDO SISTEMA...", "system")

        if self.bot.iniciar(headless=False):
            self.log_signal.emit(
                "‚úì Navegador aberto. Verificando sess√£o...", "info")
            if self.bot.aguardar_login():
                self.log_signal.emit("‚úì‚úì‚úì CONECTADO! ‚úì‚úì‚úì", "success")
                self.log_signal.emit("‚ñ∏ Sess√£o salva.", "success")
                self.status_signal.emit(True)
            else:
                self.log_signal.emit("‚úó Timeout: QR Code n√£o lido.", "error")
                self.bot.fechar()
                self.status_signal.emit(False)
        else:
            self.log_signal.emit("‚úó Erro cr√≠tico ao abrir navegador.", "error")
            self.status_signal.emit(False)


class SendThread(QThread):
    log_signal = Signal(str, str)
    progress_signal = Signal(int, int, int, int)
    finished_signal = Signal()

    def __init__(self, bot, mensagem, contatos):
        super().__init__()
        self.bot = bot
        self.mensagem = mensagem
        self.contatos = contatos
        self.success = 0
        self.failed = 0
        self.skipped = 0

    def run(self):
        total = len(self.contatos)

        self.log_signal.emit("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ", "system")
        self.log_signal.emit(f"‚ñ∏ INICIANDO DISPARO MASSIVO", "system")
        self.log_signal.emit(f"‚ñ∏ Alvos identificados: {total}", "info")
        self.log_signal.emit("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ", "system")

        for i, contato in enumerate(self.contatos, 1):
            self.log_signal.emit(
                f"‚ñ∏ [{i}/{total}] Processando alvo: {contato}", "processing")

            numero_formatado, status = self.bot.formatar_numero(contato)
            if not numero_formatado:
                self.skipped += 1
                self.log_signal.emit(
                    f"‚äò Ignorado | {contato} | {status}", "skip")
                self.progress_signal.emit(
                    self.success, self.failed, self.skipped, total)
                continue

            ok, res = self.bot.enviar(contato, self.mensagem)

            if ok:
                self.success += 1
                self.log_signal.emit(f"‚úì Executado | {contato}", "success")
            elif "n√£o cadastrado" in res.lower() or "inv√°lido" in res.lower():
                self.skipped += 1
                self.log_signal.emit(f"‚äò Alvo inv√°lido | {contato}", "skip")
            else:
                self.failed += 1
                self.log_signal.emit(f"‚úó Falha | {contato} | {res}", "error")

            self.progress_signal.emit(
                self.success, self.failed, self.skipped, total)

            if i < total:
                self.log_signal.emit("‚ñ∏ Intervalo de seguran√ßa: 8s", "warning")
                time.sleep(8)

        rate = (self.success / (self.success + self.failed) *
                100) if (self.success + self.failed) > 0 else 0

        self.log_signal.emit("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ", "system")
        self.log_signal.emit("‚úì OPERA√á√ÉO CONCLU√çDA", "success")
        self.log_signal.emit("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ", "system")
        self.log_signal.emit(f"‚ñ∏ Executados: {self.success}", "success")
        self.log_signal.emit(
            f"‚ñ∏ Falhas: {self.failed}", "error" if self.failed > 0 else "info")
        self.log_signal.emit(f"‚ñ∏ Ignorados: {self.skipped}", "skip")
        self.log_signal.emit(f"‚ñ∏ Taxa de √™xito: {rate:.1f}%", "success")
        self.log_signal.emit("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ", "system")

        self.finished_signal.emit()


class GlowButton(QPushButton):
    def __init__(self, text, icon="", color="#00FF9C"):
        super().__init__(f"{icon} {text}" if icon else text)
        self.color = color
        self.setFixedHeight(42)
        self.setCursor(Qt.PointingHandCursor)

        glow = QGraphicsDropShadowEffect()
        glow.setBlurRadius(25)
        glow.setColor(QColor(color))
        glow.setOffset(0, 0)
        self.setGraphicsEffect(glow)


class StatusIndicator(QWidget):
    def __init__(self):
        super().__init__()
        self.setFixedSize(12, 12)
        self.color = QColor("#FF3B5C")
        self.pulse_value = 1.0
        self.pulse_timer = QTimer()
        self.pulse_timer.timeout.connect(self.update_pulse)

    def set_color(self, color):
        self.color = QColor(color)
        self.update()

    def start_pulse(self):
        self.pulse_timer.start(50)

    def stop_pulse(self):
        self.pulse_timer.stop()
        self.pulse_value = 1.0
        self.update()

    def update_pulse(self):
        self.pulse_value += 0.05
        if self.pulse_value > 1.5:
            self.pulse_value = 1.0
        self.update()

    def paintEvent(self, event):
        from PySide6.QtGui import QPainter, QBrush, QPen
        painter = QPainter(self)
        painter.setRenderHint(QPainter.Antialiasing)

        glow_size = int(6 * self.pulse_value)
        glow_offset = 6 - glow_size // 2
        painter.setBrush(
            QBrush(QColor(self.color.red(), self.color.green(), self.color.blue(), 40)))
        painter.setPen(Qt.NoPen)
        painter.drawEllipse(glow_offset, glow_offset, glow_size, glow_size)

        painter.setBrush(QBrush(self.color))
        painter.drawEllipse(4, 4, 4, 4)


class BiohackerCard(QFrame):
    def __init__(self, title, icon="", parent=None):
        super().__init__(parent)
        self.setStyleSheet("""
            QFrame {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 rgba(26, 26, 35, 0.95), stop:1 rgba(15, 15, 20, 0.95));
                border: 1px solid rgba(0, 255, 156, 0.2);
                border-radius: 20px;
            }
        """)

        glow = QGraphicsDropShadowEffect()
        glow.setBlurRadius(30)
        glow.setColor(QColor(0, 255, 156, 30))
        glow.setOffset(0, 0)
        self.setGraphicsEffect(glow)

        self.main_layout = QVBoxLayout(self)
        self.main_layout.setContentsMargins(15, 12, 15, 12)
        self.main_layout.setSpacing(10)

        if title:
            header = QHBoxLayout()
            header.setSpacing(8)

            if icon:
                icon_label = QLabel(icon)
                icon_label.setFont(QFont("Segoe UI", 12))
                icon_label.setStyleSheet(
                    "color: #00FF9C; background: transparent; border: none;")
                header.addWidget(icon_label)

            title_label = QLabel(title)
            title_label.setFont(QFont("Segoe UI", 11, QFont.Bold))
            title_label.setStyleSheet(
                "color: #FFFFFF; background: transparent; border: none; letter-spacing: 1px;")
            header.addWidget(title_label)
            header.addStretch()

            self.main_layout.addLayout(header)

            sep = QFrame()
            sep.setFixedHeight(1)
            sep.setStyleSheet(
                "background: qlineargradient(x1:0, y1:0, x2:1, y2:0, stop:0 transparent, stop:0.5 rgba(0, 255, 156, 0.5), stop:1 transparent); border: none;")
            self.main_layout.addWidget(sep)


class SystemMetric(QFrame):
    def __init__(self, icon, label, value="---"):
        super().__init__()
        self.setStyleSheet("background: transparent; border: none;")

        layout = QHBoxLayout(self)
        layout.setContentsMargins(0, 5, 0, 5)
        layout.setSpacing(10)

        icon_label = QLabel(icon)
        icon_label.setFont(QFont("Segoe UI", 12))
        icon_label.setStyleSheet("color: #00FF9C; background: transparent;")
        layout.addWidget(icon_label)

        text_label = QLabel(label)
        text_label.setFont(QFont("Segoe UI", 9))
        text_label.setStyleSheet(
            "color: #8B8B9A; background: transparent; letter-spacing: 0.5px;")
        layout.addWidget(text_label)
        layout.addStretch()

        value_container = QFrame()
        value_container.setStyleSheet("""
            QFrame {
                background: rgba(0, 255, 156, 0.08);
                border: 1px solid rgba(0, 255, 156, 0.2);
                border-radius: 12px;
                padding: 4px 12px;
            }
        """)
        value_layout = QHBoxLayout(value_container)
        value_layout.setContentsMargins(10, 3, 10, 3)

        self.value_label = QLabel(value)
        self.value_label.setFont(QFont("Consolas", 10, QFont.Bold))
        self.value_label.setStyleSheet(
            "color: #00FF9C; background: transparent; border: none;")
        value_layout.addWidget(self.value_label)

        layout.addWidget(value_container)

    def set_value(self, value):
        self.value_label.setText(str(value))


class WhatsAppBotWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        self.bot = WhatsAppBot()
        self.connected = False
        self.start_time = None
        self.stats = {"sent": 0, "success": 0, "failed": 0, "skipped": 0}
        self.is_sending = False

        self.setup_ui()
        self.apply_styles()
        self.start_timer()

    def setup_ui(self):
        self.setWindowTitle("WhatsApp Bot // Professional Edition 2.0")
        self.setGeometry(100, 80, 950, 600)
        self.setMinimumSize(950, 600)

        central = QWidget()
        self.setCentralWidget(central)
        main_layout = QVBoxLayout(central)
        main_layout.setSpacing(12)
        main_layout.setContentsMargins(18, 18, 18, 18)

        header = self.create_header()
        main_layout.addWidget(header)

        content = QHBoxLayout()
        content.setSpacing(15)

        left = self.create_left_column()
        content.addWidget(left, 3)

        right = self.create_right_column()
        content.addWidget(right, 2)

        main_layout.addLayout(content)

    def create_header(self):
        header = QFrame()
        header.setFixedHeight(75)
        header.setStyleSheet("background: transparent; border: none;")
        layout = QHBoxLayout(header)
        layout.setContentsMargins(0, 0, 0, 0)

        title_container = QFrame()
        title_container.setStyleSheet("background: transparent; border: none;")
        title_layout = QHBoxLayout(title_container)
        title_layout.setContentsMargins(0, 0, 0, 0)
        title_layout.setSpacing(12)

        logo = QLabel("‚ö°")
        logo.setFont(QFont("Segoe UI", 32))
        logo.setStyleSheet("color: #00FF9C; background: transparent;")
        title_layout.addWidget(logo)

        text_block = QFrame()
        text_block.setStyleSheet("background: transparent; border: none;")
        text_layout = QVBoxLayout(text_block)
        text_layout.setContentsMargins(0, 0, 0, 0)
        text_layout.setSpacing(2)

        title = QLabel("WHATSAPP BOT")
        title.setFont(QFont("Segoe UI", 20, QFont.Bold))
        title.setStyleSheet(
            "color: #FFFFFF; background: transparent; letter-spacing: 2px;")
        text_layout.addWidget(title)

        subtitle = QLabel("TEXT MESSAGING SYSTEM")
        subtitle.setFont(QFont("Consolas", 8))
        subtitle.setStyleSheet(
            "color: #00FF9C; background: transparent; letter-spacing: 1px;")
        text_layout.addWidget(subtitle)

        title_layout.addWidget(text_block)
        layout.addWidget(title_container)
        layout.addStretch()

        status_container = QFrame()
        status_container.setStyleSheet("""
            QFrame {
                background: rgba(26, 26, 35, 0.8);
                border: 1px solid rgba(255, 59, 92, 0.3);
                border-radius: 18px;
                padding: 10px 20px;
            }
        """)
        status_layout = QHBoxLayout(status_container)
        status_layout.setContentsMargins(20, 10, 20, 10)
        status_layout.setSpacing(10)

        self.status_indicator = StatusIndicator()
        status_layout.addWidget(self.status_indicator)

        self.status_label = QLabel("DESCONECTADO")
        self.status_label.setFont(QFont("Consolas", 10, QFont.Bold))
        self.status_label.setStyleSheet(
            "color: #FF3B5C; background: transparent; border: none; letter-spacing: 1px;")
        status_layout.addWidget(self.status_label)

        layout.addWidget(status_container)

        return header

    def create_left_column(self):
        left = QFrame()
        left.setStyleSheet("background: transparent; border: none;")
        layout = QVBoxLayout(left)
        layout.setSpacing(12)
        layout.setContentsMargins(0, 0, 0, 0)

        btn_layout = QHBoxLayout()
        btn_layout.setSpacing(12)

        self.btn_connect = GlowButton("CONECTAR", "‚óâ", "#00FF9C")
        self.btn_connect.clicked.connect(self.conectar)
        self.btn_connect.setStyleSheet("""
            QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 rgba(0, 255, 156, 0.15), stop:1 rgba(0, 255, 156, 0.05));
                color: #00FF9C;
                border: 1px solid rgba(0, 255, 156, 0.3);
                border-radius: 25px;
                font-size: 13px;
                font-weight: bold;
                letter-spacing: 1px;
                font-family: 'Consolas';
            }
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 rgba(0, 255, 156, 0.25), stop:1 rgba(0, 255, 156, 0.15));
            }
        """)
        btn_layout.addWidget(self.btn_connect)

        self.btn_send = GlowButton("EXECUTAR", "‚ñ∏", "#7A5CFF")
        self.btn_send.clicked.connect(self.disparar)
        self.btn_send.setEnabled(False)
        self.btn_send.setStyleSheet("""
            QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 rgba(122, 92, 255, 0.15), stop:1 rgba(122, 92, 255, 0.05));
                color: #7A5CFF;
                border: 1px solid rgba(122, 92, 255, 0.3);
                border-radius: 25px;
                font-size: 13px;
                font-weight: bold;
                letter-spacing: 1px;
                font-family: 'Consolas';
            }
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1,
                    stop:0 rgba(122, 92, 255, 0.25), stop:1 rgba(122, 92, 255, 0.15));
            }
            QPushButton:disabled {
                background: rgba(40, 40, 50, 0.3);
                color: #4A4A5A;
                border: 1px solid rgba(74, 74, 90, 0.2);
            }
        """)
        btn_layout.addWidget(self.btn_send)

        layout.addLayout(btn_layout)

        msg_card = BiohackerCard("MENSAGEM", "‚óà")
        self.txt_msg = QTextEdit()
        self.txt_msg.setPlaceholderText(
            "Digite a mensagem que ser√° enviada...")
        self.txt_msg.setStyleSheet("""
            QTextEdit {
                background: rgba(15, 15, 20, 0.6);
                color: #E0E0E8;
                border: 1px solid rgba(0, 255, 156, 0.15);
                border-radius: 15px;
                padding: 10px;
                font-size: 11px;
                font-family: 'Segoe UI';
            }
            QTextEdit:focus {
                border: 1px solid rgba(0, 255, 156, 0.4);
            }
        """)
        msg_card.main_layout.addWidget(self.txt_msg)
        layout.addWidget(msg_card)

        contacts_card = BiohackerCard("ALVOS // CONTATOS", "‚óé")
        self.txt_contacts = QTextEdit()
        self.txt_contacts.setPlaceholderText(
            "11987654321\n11912345678\n11987651234\n...")
        self.txt_contacts.setStyleSheet("""
            QTextEdit {
                background: rgba(15, 15, 20, 0.6);
                color: #E0E0E8;
                border: 1px solid rgba(0, 255, 156, 0.15);
                border-radius: 15px;
                padding: 10px;
                font-size: 11px;
                font-family: 'Consolas';
            }
        """)
        contacts_card.main_layout.addWidget(self.txt_contacts)
        layout.addWidget(contacts_card)

        return left

    def create_right_column(self):
        right = QFrame()
        right.setStyleSheet("background: transparent; border: none;")
        right.setFixedWidth(340)
        layout = QVBoxLayout(right)
        layout.setSpacing(12)
        layout.setContentsMargins(0, 0, 0, 0)

        metrics_card = BiohackerCard("M√âTRICAS DO SISTEMA", "‚óâ")

        self.metric_time = SystemMetric("‚ßó", "TEMPO ATIVO", "00:00:00")
        self.metric_sent = SystemMetric("‚óà", "EXECUTADOS", "0")
        self.metric_rate = SystemMetric("‚óé", "TAXA DE √äXITO", "0%")

        metrics_card.main_layout.addWidget(self.metric_time)
        metrics_card.main_layout.addWidget(self.metric_sent)
        metrics_card.main_layout.addWidget(self.metric_rate)

        info_frame = QFrame()
        info_frame.setStyleSheet("""
            QFrame {
                background: rgba(0, 255, 156, 0.05);
                border: 1px solid rgba(0, 255, 156, 0.15);
                border-radius: 12px;
                padding: 12px;
            }
        """)
        info_layout = QVBoxLayout(info_frame)
        info_layout.setSpacing(6)

        info_title = QLabel("‚óâ SISTEMA DE MENSAGENS")
        info_title.setFont(QFont("Consolas", 9, QFont.Bold))
        info_title.setStyleSheet(
            "color: #00FF9C; background: transparent; border: none;")
        info_layout.addWidget(info_title)

        protocols = [
            "‚ñ∏ Envio de mensagens de texto",
            "‚ñ∏ Logs detalhados no terminal",
            "‚ñ∏ Valida√ß√£o autom√°tica de n√∫meros",
            "‚ñ∏ Intervalo de seguran√ßa: 8s",
            "‚ñ∏ Sess√£o persistente salva"
        ]

        for protocol in protocols:
            p_label = QLabel(protocol)
            p_label.setFont(QFont("Segoe UI", 8))
            p_label.setStyleSheet(
                "color: #8B8B9A; background: transparent; border: none;")
            p_label.setWordWrap(True)
            info_layout.addWidget(p_label)

        metrics_card.main_layout.addWidget(info_frame)
        metrics_card.main_layout.addStretch()

        layout.addWidget(metrics_card)

        logs_card = BiohackerCard("TERMINAL // LOGS", "‚óà")
        self.log_view = QTextEdit()
        self.log_view.setReadOnly(True)
        self.log_view.setFont(QFont("Consolas", 8))
        self.log_view.setStyleSheet("""
            QTextEdit {
                background: rgba(11, 11, 15, 0.8);
                color: #00FF9C;
                border: 1px solid rgba(0, 255, 156, 0.1);
                border-radius: 12px;
                padding: 10px;
            }
        """)
        logs_card.main_layout.addWidget(self.log_view)
        layout.addWidget(logs_card)

        return right

    def apply_styles(self):
        self.setStyleSheet("""
            QMainWindow {
                background: qlineargradient(x1:0, y1:0, x2:1, y2:1,
                    stop:0 #0B0B0F, stop:1 #12121A);
            }
            QWidget {
                background: transparent;
                color: #FFFFFF;
            }
        """)

    def log(self, msg, tipo="info"):
        colors = {
            "info": "#00D9FF",
            "success": "#00FF9C",
            "error": "#FF3B5C",
            "warning": "#FFB84D",
            "processing": "#7A5CFF",
            "skip": "#6B6B7A",
            "system": "#00FF9C"
        }

        timestamp = datetime.now().strftime('%H:%M:%S')
        color = colors.get(tipo, colors["info"])
        html = f'<span style="color: #4A4A5A;">[{timestamp}]</span> '
        html += f'<span style="color: {color};">{msg}</span><br>'
        self.log_view.insertHtml(html)
        self.log_view.verticalScrollBar().setValue(
            self.log_view.verticalScrollBar().maximum())

    def conectar(self):
        self.btn_connect.setEnabled(False)
        self.connection_thread = ConnectionThread(self.bot)
        self.connection_thread.log_signal.connect(self.log)
        self.connection_thread.status_signal.connect(self.on_connection_result)
        self.connection_thread.start()

    def on_connection_result(self, success):
        if success:
            self.connected = True
            self.start_time = time.time()
            self.status_label.setText("CONECTADO")
            self.status_label.setStyleSheet(
                "color: #00FF9C; background: transparent; border: none;")
            self.status_indicator.set_color("#00FF9C")
            self.status_indicator.start_pulse()
            self.btn_send.setEnabled(True)
        else:
            self.btn_connect.setEnabled(True)
            QMessageBox.critical(
                self, "‚úó FALHA", "N√£o foi poss√≠vel estabelecer conex√£o")

    def disparar(self):
        if self.is_sending:
            QMessageBox.warning(self, "‚ö† ATEN√á√ÉO", "Aguarde a opera√ß√£o atual")
            return

        msg = self.txt_msg.toPlainText().strip()
        contatos = [c.strip()
                    for c in self.txt_contacts.toPlainText().split('\n') if c.strip()]

        if not msg or not contatos:
            QMessageBox.warning(self, "‚ö† DADOS INSUFICIENTES",
                                "Preencha a mensagem e os alvos")
            return

        reply = QMessageBox.question(
            self,
            "‚óâ CONFIRMAR EXECU√á√ÉO",
            f"Executar opera√ß√£o para {len(contatos)} alvos?",
            QMessageBox.Yes | QMessageBox.No
        )

        if reply != QMessageBox.Yes:
            self.log("‚ñ∏ Opera√ß√£o cancelada", "warning")
            return

        self.is_sending = True
        self.btn_send.setEnabled(False)
        self.btn_connect.setEnabled(False)

        self.send_thread = SendThread(self.bot, msg, contatos)
        self.send_thread.log_signal.connect(self.log)
        self.send_thread.progress_signal.connect(self.update_stats)
        self.send_thread.finished_signal.connect(self.on_send_finished)
        self.send_thread.start()

    def update_stats(self, success, failed, skipped, total):
        self.stats = {"success": success, "failed": failed, "skipped": skipped}
        sent = success + failed
        rate = (success / sent * 100) if sent > 0 else 0

        if self.start_time:
            elapsed = int(time.time() - self.start_time)
            h, m, s = elapsed // 3600, (elapsed % 3600) // 60, elapsed % 60
            self.metric_time.set_value(f"{h:02d}:{m:02d}:{s:02d}")

        self.metric_sent.set_value(str(sent))
        self.metric_rate.set_value(f"{rate:.1f}%")

    def on_send_finished(self):
        self.btn_send.setEnabled(True)
        self.btn_connect.setEnabled(False)
        self.is_sending = False

        total = self.stats['success'] + self.stats['failed']
        rate = (self.stats['success'] / total * 100) if total > 0 else 0

        QMessageBox.information(
            self,
            "‚úì OPERA√á√ÉO CONCLU√çDA",
            f"Relat√≥rio de execu√ß√£o:\n\n"
            f"‚ñ∏ Executados: {self.stats['success']}\n"
            f"‚ñ∏ Falhas: {self.stats['failed']}\n"
            f"‚ñ∏ Ignorados: {self.stats['skipped']}\n"
            f"‚ñ∏ Taxa de √™xito: {rate:.1f}%"
        )

    def start_timer(self):
        self.timer = QTimer()
        self.timer.timeout.connect(self.update_time)
        self.timer.start(1000)

    def update_time(self):
        if self.start_time:
            elapsed = int(time.time() - self.start_time)
            h, m, s = elapsed // 3600, (elapsed % 3600) // 60, elapsed % 60
            self.metric_time.set_value(f"{h:02d}:{m:02d}:{s:02d}")

    def closeEvent(self, event):
        if self.bot.driver:
            self.bot.fechar()
        event.accept()


if __name__ == "__main__":
    app = QApplication(sys.argv)
    app.setFont(QFont("Segoe UI", 9))

    print("="*60)
    print("üì± WHATSAPP BOT - TEXT MESSAGING SYSTEM")
    print("="*60)
    print("Sistema de envio de mensagens de texto")
    print("Logs detalhados aparecer√£o no terminal")
    print("="*60)
    print()

    window = WhatsAppBotWindow()
    window.show()
    sys.exit(app.exec())
